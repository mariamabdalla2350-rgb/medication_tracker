<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediTrack Senior - Medication Tracker</title>
    <style>
        :root {
            --primary: #2c6e36;
            --secondary: #1a4a24;
            --accent: #e67e22;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --gray: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--dark);
            background: linear-gradient(135deg, #e6f7e9 0%, #ffffff 100%);
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        header {
            text-align: center;
            padding: 25px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: "üíä";
            position: absolute;
            font-size: 120px;
            opacity: 0.15;
            top: -20px;
            right: -30px;
            transform: rotate(15deg);
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 2;
        }
        
        .subtitle {
            font-size: 1.4rem;
            opacity: 0.9;
            max-width: 700px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }
        
        .patient-banner {
            background: white;
            padding: 15px 25px;
            border-radius: 50px;
            display: inline-block;
            margin-top: 12px;
            font-weight: bold;
            font-size: 1.3rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 2;
        }
        
        .today-header {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 15px;
        }
        
        .today-date {
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--secondary);
            margin: 10px 0;
        }
        
        .reminders {
            background: linear-gradient(to right, var(--warning), #ff9800);
            color: var(--dark);
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 20px 0;
            box-shadow: var(--box-shadow);
            border-left: 6px solid #ff5722;
        }
        
        .reminder-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.8rem;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .reminder-list {
            padding-left: 25px;
            font-size: 1.5rem;
            line-height: 1.8;
        }
        
        .reminder-list li {
            margin-bottom: 8px;
            padding-left: 10px;
            border-left: 3px solid var(--dark);
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 15px;
        }
        
        .med-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 3px solid var(--gray);
        }
        
        .med-card.taken {
            border-color: var(--success);
            background-color: #e8f5e9;
        }
        
        .med-card.not-taken {
            border-color: var(--accent);
            background-color: #fff8e1;
        }
        
        .med-name {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--secondary);
        }
        
        .med-details {
            font-size: 1.4rem;
            margin: 12px 0;
            padding-left: 15px;
            border-left: 3px solid var(--gray);
        }
        
        .med-reminder {
            background: #fff3cd;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-weight: 500;
            font-size: 1.3rem;
            color: #856404;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            flex: 1;
            min-width: 140px;
            padding: 18px 15px;
            border: none;
            border-radius: 60px;
            font-size: 1.4rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn-primary {
            background: linear-gradient(to right, var(--primary), #215a2a);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(to right, var(--accent), #d35400);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(to right, var(--success), #218838);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(to right, var(--danger), #c82333);
            color: white;
        }
        
        .btn-outline {
            background: transparent;
            border: 3px solid var(--primary);
            color: var(--primary);
            font-weight: bold;
        }
        
        .btn-lg {
            padding: 22px 25px;
            font-size: 1.6rem;
        }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
            margin-top: 10px;
        }
        
        .menu-item {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: var(--box-shadow);
            border: 3px solid #e9ecef;
        }
        
        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            border-color: var(--primary);
        }
        
        .menu-item i {
            font-size: 3.5rem;
            margin-bottom: 15px;
            display: block;
        }
        
        .menu-item.hospital { color: var(--primary); }
        .menu-item.check-circle { color: var(--success); }
        .menu-item.ban { color: var(--danger); }
        .menu-item.list { color: var(--secondary); }
        .menu-item.plus { color: #17a2b8; }
        .menu-item.sync { color: #6f42c1; }
        .menu-item.file-alt { color: var(--accent); }
        .menu-item.chart-bar { color: #e83e8c; }
        .menu-item.sign-out { color: var(--gray); }
        
        .menu-title {
            font-size: 1.6rem;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 95%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: modalOpen 0.4s;
        }
        
        @keyframes modalOpen {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: 25px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            text-align: center;
            font-size: 2.2rem;
            font-weight: bold;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 12px;
            font-size: 1.6rem;
            font-weight: 500;
            color: var(--secondary);
        }
        
        .form-control {
            width: 100%;
            padding: 18px;
            font-size: 1.6rem;
            border: 3px solid #ddd;
            border-radius: 12px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 4px rgba(44, 110, 54, 0.2);
        }
        
        .time-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 10px;
        }
        
        .time-btn {
            padding: 15px;
            font-size: 1.4rem;
            border: 3px solid #ddd;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .time-btn.selected, .time-btn:hover {
            border-color: var(--primary);
            background: #e8f5e9;
            font-weight: bold;
        }
        
        .voice-hint {
            background: #e3f2fd;
            border-left: 5px solid #2196f3;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin: 20px 0;
            font-size: 1.3rem;
        }
        
        .voice-hint::before {
            content: "üîä Voice Assist Tip: ";
            font-weight: bold;
            color: #1976d2;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.3rem;
        }
        
        .badge-taken {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-missed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .weekly-summary {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            margin-top: 20px;
            box-shadow: var(--box-shadow);
            font-size: 1.4rem;
            line-height: 1.8;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .weekly-summary h3 {
            color: var(--secondary);
            margin: 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }
        
        .weekly-summary .med-name {
            font-size: 1.8rem;
            margin: 20px 0 10px;
            color: var(--primary);
        }
        
        .adherence-bar {
            height: 25px;
            background: #e9ecef;
            border-radius: 12px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .adherence-fill {
            height: 100%;
            background: linear-gradient(to right, var(--success), #218838);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .daily-overview {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px dashed #ddd;
        }
        
        .daily-item {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }
        
        .daily-item:last-child {
            border-bottom: none;
        }
        
        .missed-list {
            color: var(--danger);
            font-weight: 500;
            margin-top: 5px;
            font-size: 1.3rem;
        }
        
        footer {
            text-align: center;
            padding: 25px;
            margin-top: 20px;
            color: var(--secondary);
            font-size: 1.4rem;
            border-top: 2px solid var(--primary);
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 2.3rem;
            }
            
            .subtitle {
                font-size: 1.2rem;
            }
            
            .btn {
                padding: 15px 10px;
                font-size: 1.3rem;
            }
            
            .menu-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                max-width: 500px;
            }
        }
        
        @media (max-width: 480px) {
            .menu-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .time-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>MediTrack Senior</h1>
            <p class="subtitle">Simple, safe medication tracking designed for seniors and caregivers</p>
            <div class="patient-banner" id="patientName">Patient: Loading...</div>
        </header>
        
        <div class="today-header">
            <div class="today-date" id="currentDate">Loading date...</div>
            <div class="voice-hint">"Good morning! I see you have medications to take at 9 AM and 7 PM today."</div>
        </div>
        
        <div class="reminders" id="remindersSection" style="display: none;">
            <div class="reminder-title">
                <span>‚ö†Ô∏è</span> REMINDERS - Please take:
            </div>
            <ul class="reminder-list" id="reminderList">
                <!-- Reminders will be inserted here by JavaScript -->
            </ul>
        </div>
        
        <div class="status-grid" id="medicationsGrid">
            <!-- Medication cards will be inserted here by JavaScript -->
        </div>
        
        <div class="menu-grid">
            <div class="menu-item hospital" onclick="showModal('addMedModal')">
                <i>‚úö</i>
                <div class="menu-title">Add Medication</div>
            </div>
            <div class="menu-item check-circle" onclick="markAllTaken()">
                <i>‚úì</i>
                <div class="menu-title">Mark All Taken</div>
            </div>
            <div class="menu-item ban" onclick="showModal('missedModal')">
                <i>‚äò</i>
                <div class="menu-title">Mark Missed</div>
            </div>
            <div class="menu-item list" onclick="showAllMeds()">
                <i>üìã</i>
                <div class="menu-title">View All</div>
            </div>
            <div class="menu-item sync" onclick="showModal('refillModal')">
                <i>‚ü≥</i>
                <div class="menu-title">Refill</div>
            </div>
            <div class="menu-item chart-bar" onclick="showWeeklySummary()">
                <i>üìä</i>
                <div class="menu-title">Weekly Summary</div>
            </div>
            <div class="menu-item file-alt" onclick="saveReport()">
                <i>üìÑ</i>
                <div class="menu-title">Save Report</div>
            </div>
            <div class="menu-item sign-out" onclick="logout()">
                <i>üö™</i>
                <div class="menu-title">Exit</div>
            </div>
        </div>
    </div>
    
    <!-- Add Medication Modal -->
    <div class="modal" id="addMedModal">
        <div class="modal-content">
            <div class="modal-header">‚úö Add New Medication</div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="medName">Medication Name</label>
                    <input type="text" id="medName" class="form-control" placeholder="e.g., Lisinopril">
                </div>
                <div class="form-group">
                    <label for="medDosage">Dosage</label>
                    <input type="text" id="medDosage" class="form-control" placeholder="e.g., 1 pill, 5ml">
                </div>
                <div class="form-group">
                    <label>Time of Day</label>
                    <div class="time-options">
                        <button class="time-btn" onclick="selectTime(this, 'Morning')">üåÖ Morning</button>
                        <button class="time-btn" onclick="selectTime(this, 'Afternoon')">‚òÄÔ∏è Afternoon</button>
                        <button class="time-btn" onclick="selectTime(this, 'Evening')">üåá Evening</button>
                        <button class="time-btn" onclick="selectTime(this, 'Bedtime')">üåô Bedtime</button>
                    </div>
                    <input type="hidden" id="medTime" value="Morning">
                </div>
                <div class="form-group">
                    <label for="medCount">Starting Quantity (doses)</label>
                    <input type="number" id="medCount" class="form-control" value="30" min="1">
                </div>
                <div class="action-buttons">
                    <button class="btn btn-success btn-lg" onclick="addMedication()">
                        <span>‚úì</span> Add Medication
                    </button>
                    <button class="btn btn-outline btn-lg" onclick="closeModal('addMedModal')">
                        <span>√ó</span> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Weekly Summary Modal -->
    <div class="modal" id="summaryModal">
        <div class="modal-content">
            <div class="modal-header">üìä Weekly Summary</div>
            <div class="modal-body">
                <div class="weekly-summary" id="summaryContent">
                    <!-- Summary content will be inserted by JavaScript -->
                </div>
                <div class="action-buttons" style="margin-top: 25px;">
                    <button class="btn btn-primary btn-lg" onclick="saveReport()">
                        <span>‚Üì</span> Save Report
                    </button>
                    <button class="btn btn-outline btn-lg" onclick="closeModal('summaryModal')">
                        <span>√ó</span> Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Setup Modal (shows on first load) -->
    <div class="modal" id="setupModal" style="display: flex;">
        <div class="modal-content">
            <div class="modal-header">Welcome to MediTrack Senior</div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="setupPatientName">Enter Patient Name</label>
                    <input type="text" id="setupPatientName" class="form-control" placeholder="e.g., John Smith" value="Grandma Smith">
                </div>
                <div class="voice-hint">"Say your name clearly for best results with voice commands"</div>
                <div class="action-buttons">
                    <button class="btn btn-primary btn-lg" onclick="setupPatient()">
                        <span>‚úì</span> Start Tracking
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <p>MediTrack Senior ‚Ä¢ Medication Safety for Loved Ones ‚Ä¢ v2.0</p>
        <p style="margin-top: 8px; font-size: 1.2rem; color: var(--gray);">
            üí° Tip: Press any button twice for voice confirmation ‚Ä¢ 
            üåê Works offline ‚Ä¢ 
            üîí Your data stays on this device
        </p>
    </footer>
    
    <script>
        // ======================
        // STATE MANAGEMENT
        // ======================
        let patientName = localStorage.getItem('patientName') || '';
        let medications = JSON.parse(localStorage.getItem('medications')) || [];
        let dailyLogs = JSON.parse(localStorage.getItem('dailyLogs')) || {};
        const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
        
        // ======================
        // INITIALIZATION
        // ======================
        window.addEventListener('DOMContentLoaded', () => {
            if (!patientName) {
                document.getElementById('setupModal').style.display = 'flex';
            } else {
                document.getElementById('patientName').textContent = `Patient: ${patientName}`;
                loadToday();
                updateUI();
            }
            document.getElementById('currentDate').textContent = formatDate(new Date());
        });
        
        function formatDate(date) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }
        
        function setupPatient() {
            const name = document.getElementById('setupPatientName').value.trim() || 'Patient';
            patientName = name;
            localStorage.setItem('patientName', name);
            document.getElementById('patientName').textContent = `Patient: ${name}`;
            document.getElementById('setupModal').style.display = 'none';
            updateUI();
        }
        
        // ======================
        // CORE FUNCTIONALITY
        // ======================
        function loadToday() {
            // Initialize today's log if not exists
            if (!dailyLogs[today]) {
                dailyLogs[today] = {
                    date: today,
                    taken: {}
                };
                // Mark all medications as not taken for new day
                medications.forEach(med => {
                    dailyLogs[today].taken[med.name] = false;
                });
                saveData();
            }
        }
        
        function updateUI() {
            // Update reminders section
            const missed = medications.filter(med => 
                !dailyLogs[today]?.taken[med.name]
            );
            
            const remindersSection = document.getElementById('remindersSection');
            const reminderList = document.getElementById('reminderList');
            
            if (missed.length > 0) {
                remindersSection.style.display = 'block';
                reminderList.innerHTML = '';
                missed.forEach(med => {
                    const li = document.createElement('li');
                    li.textContent = `${med.name} at ${med.time_of_day}`;
                    reminderList.appendChild(li);
                });
            } else {
                remindersSection.style.display = 'none';
            }
            
            // Update medication cards
            const grid = document.getElementById('medicationsGrid');
            grid.innerHTML = '';
            
            if (medications.length === 0) {
                grid.innerHTML = `
                    <div class="med-card" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <h2 style="font-size: 2rem; color: var(--gray); margin-bottom: 20px;">üì≠ No medications added yet</h2>
                        <p style="font-size: 1.4rem; margin-bottom: 25px;">Click "Add Medication" to get started</p>
                        <button class="btn btn-primary btn-lg" onclick="showModal('addMedModal')" style="padding: 15px 40px; font-size: 1.5rem;">
                            <span>‚úö</span> Add First Medication
                        </button>
                    </div>
                `;
                return;
            }
            
            medications.forEach(med => {
                const isTaken = dailyLogs[today]?.taken[med.name] || false;
                const card = document.createElement('div');
                card.className = `med-card ${isTaken ? 'taken' : 'not-taken'}`;
                card.innerHTML = `
                    <div class="med-name">${med.name}</div>
                    <div class="med-details">${med.dosage} ‚Ä¢ ${med.time_of_day}</div>
                    <div class="med-details">üíä Remaining: ${med.current_count} of ${med.total_prescribed} doses</div>
                    ${!isTaken ? `<div class="med-reminder">‚ö†Ô∏è Reminder: Take at ${med.time_of_day}</div>` : ''}
                    <div class="action-buttons">
                        <button class="btn ${isTaken ? 'btn-outline' : 'btn-success'}" 
                                onclick="toggleMedStatus('${med.name}', true)">
                            ${isTaken ? '‚úì Already Taken' : '‚úì Mark as Taken'}
                        </button>
                        <button class="btn ${isTaken ? 'btn-warning' : 'btn-outline'}" 
                                onclick="toggleMedStatus('${med.name}', false)">
                            ${isTaken ? '‚äò Mark as Missed' : '‚äò Not Taken'}
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        function toggleMedStatus(medName, taken) {
            // Safety check: prevent taking when no doses left
            const med = medications.find(m => m.name === medName);
            if (taken && med.current_count <= 0) {
                alert(`‚ö†Ô∏è Cannot take ${medName} - no doses remaining! Please refill.`);
                return;
            }
            
            // Update log
            if (!dailyLogs[today]) {
                dailyLogs[today] = { date: today, taken: {} };
            }
            const wasTaken = dailyLogs[today].taken[medName] || false;
            dailyLogs[today].taken[medName] = taken;
            
            // Update medication count ONLY on state change
            if (taken && !wasTaken) {
                med.current_count -= 1;
            } else if (!taken && wasTaken) {
                med.current_count += 1;
            }
            
            saveData();
            updateUI();
            
            // Voice feedback
            const status = taken ? 'taken' : 'marked as missed';
            speak(`Medication ${medName} has been ${status}. ${med.current_count} doses remaining.`);
        }
        
        function markAllTaken() {
            let anyMissed = false;
            medications.forEach(med => {
                if (!dailyLogs[today]?.taken[med.name] && med.current_count > 0) {
                    dailyLogs[today].taken[med.name] = true;
                    med.current_count -= 1;
                    anyMissed = true;
                }
            });
            
            if (!anyMissed) {
                speak("All medications have already been taken today!");
                return;
            }
            
            saveData();
            updateUI();
            speak("All medications marked as taken for today!");
        }
        
        function addMedication() {
            const name = document.getElementById('medName').value.trim();
            const dosage = document.getElementById('medDosage').value.trim();
            const time = document.getElementById('medTime').value;
            const count = parseInt(document.getElementById('medCount').value) || 30;
            
            if (!name || !dosage) {
                alert('Please fill in medication name and dosage');
                return;
            }
            
            // Check for duplicate
            if (medications.some(med => med.name.toLowerCase() === name.toLowerCase())) {
                alert(`Medication "${name}" already exists!`);
                return;
            }
            
            medications.push({
                name,
                dosage,
                time_of_day: time,
                current_count: count,
                total_prescribed: count
            });
            
            // Initialize in today's log
            if (dailyLogs[today]) {
                dailyLogs[today].taken[name] = false;
            }
            
            saveData();
            closeModal('addMedModal');
            updateUI();
            speak(`Added ${name} to your medication list. ${count} doses available.`);
            
            // Reset form
            document.getElementById('medName').value = '';
            document.getElementById('medDosage').value = '';
            document.getElementById('medCount').value = '30';
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelector('.time-btn:first-child').classList.add('selected');
        }
        
        function refillMedication() {
            const name = document.getElementById('refillMed').value;
            const amount = parseInt(document.getElementById('refillAmount').value) || 0;
            
            if (amount <= 0) {
                alert('Please enter a valid refill amount');
                return;
            }
            
            const med = medications.find(m => m.name === name);
            if (med) {
                med.current_count += amount;
                med.total_prescribed += amount;
                saveData();
                closeModal('refillModal');
                updateUI();
                speak(`${name} refilled with ${amount} doses. New total: ${med.current_count} doses.`);
            }
        }
        
        function showWeeklySummary() {
            const summary = generateWeeklySummary();
            document.getElementById('summaryContent').innerHTML = summary;
            showModal('summaryModal');
        }
        
        function generateWeeklySummary() {
            // Get start of week (Monday)
            const todayDate = new Date();
            const dayOfWeek = todayDate.getDay(); // 0=Sun, 1=Mon
            const diff = todayDate.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Adjust to Monday
            const weekStart = new Date(todayDate.setDate(diff));
            const weekStartStr = weekStart.toISOString().split('T')[0];
            
            // Calculate stats
            let summaryHTML = `
                <h2>Weekly Summary for ${patientName}</h2>
                <p><strong>Week of:</strong> ${formatDate(weekStart)} to ${formatDate(new Date(weekStart.getTime() + 6 * 86400000))}</p>
            `;
            
            medications.forEach(med => {
                // Calculate taken count for this week
                let takenCount = 0;
                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart.getTime() + i * 86400000);
                    const dateStr = date.toISOString().split('T')[0];
                    if (dailyLogs[dateStr]?.taken[med.name]) {
                        takenCount++;
                    }
                }
                
                const percentage = Math.round((takenCount / 7) * 100);
                summaryHTML += `
                    <div class="med-name">${med.name} (${med.dosage})</div>
                    <p><strong>Daily Record:</strong></p>
                    <div style="display: flex; gap: 8px; margin: 15px 0; flex-wrap: wrap;">
                `;
                
                // Show daily symbols
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart.getTime() + i * 86400000);
                    const dateStr = date.toISOString().split('T')[0];
                    const isTaken = dailyLogs[dateStr]?.taken[med.name] || false;
                    summaryHTML += `<div style="text-align: center; min-width: 50px;">
                        <div style="font-weight: bold;">${days[i]}</div>
                        <div style="font-size: 1.8rem; margin-top: 5px;">${isTaken ? '‚úì' : '‚úó'}</div>
                    </div>`;
                }
                
                summaryHTML += `
                    </div>
                    <p><strong>Adherence:</strong> ${takenCount}/7 days (${percentage}%)</p>
                    <div class="adherence-bar">
                        <div class="adherence-fill" style="width: ${percentage}%">${percentage}%</div>
                    </div>
                    <p><strong>Remaining:</strong> ${med.current_count} of ${med.total_prescribed} doses</p>
                    <hr style="margin: 25px 0; border: 0; border-top: 1px solid #eee;">
                `;
            });
            
            // Daily overview
            summaryHTML += `<div class="daily-overview"><h3>Daily Overview</h3>`;
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart.getTime() + i * 86400000);
                const dateStr = date.toISOString().split('T')[0];
                const dayName = days[i];
                const takenCount = medications.filter(med => 
                    dailyLogs[dateStr]?.taken[med.name]
                ).length;
                
                let missedHTML = '';
                if (takenCount < medications.length) {
                    const missed = medications
                        .filter(med => !dailyLogs[dateStr]?.taken[med.name])
                        .map(med => med.name);
                    missedHTML = `<div class="missed-list">MISSED: ${missed.join(', ')}</div>`;
                }
                
                summaryHTML += `
                    <div class="daily-item">
                        <strong>${dayName} (${date.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})})</strong>
                        <div>${takenCount}/${medications.length} taken${missedHTML ? '<br>' + missedHTML : ''}</div>
                    </div>
                `;
            }
            summaryHTML += `</div>`;
            
            return summaryHTML;
        }
        
        function saveReport() {
            const summary = generateWeeklySummary();
            const blob = new Blob([summary.replace(/<[^>]*>/g, '')], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${patientName}_weekly_report_${today}.txt`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 0);
            speak("Weekly report saved to your downloads folder!");
        }
        
        // ======================
        // UI HELPERS
        // ======================
        function showModal(modalId) {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
            document.getElementById(modalId).style.display = 'flex';
            
            // Special handling for refill modal
            if (modalId === 'refillModal' && medications.length > 0) {
                const select = document.getElementById('refillMed');
                select.innerHTML = '';
                medications.forEach(med => {
                    const option = document.createElement('option');
                    option.value = med.name;
                    option.textContent = `${med.name} (${med.current_count} left)`;
                    select.appendChild(option);
                });
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function selectTime(element, time) {
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('medTime').value = time;
        }
        
        function showAllMeds() {
            if (medications.length === 0) {
                alert('No medications added yet!');
                return;
            }
            
            let message = `üìã ALL MEDICATIONS FOR ${patientName}\n\n`;
            medications.forEach(med => {
                const status = dailyLogs[today]?.taken[med.name] ? '‚úì TAKEN' : '‚äò NOT TAKEN';
                message += `‚Ä¢ ${med.name}\n  ${med.dosage} at ${med.time_of_day}\n  Status: ${status}\n  Remaining: ${med.current_count} of ${med.total_prescribed}\n\n`;
            });
            alert(message);
        }
        
        function logout() {
            if (confirm('Are you sure you want to exit? Your data is saved automatically.')) {
                // In a real app, this might clear session or redirect
                speak("Thank you for using MediTrack Senior. Stay healthy!");
                // For demo, just reload to setup screen
                localStorage.removeItem('patientName');
                location.reload();
            }
        }
        
        // ======================
        // PERSISTENCE & VOICE
        // ======================
        function saveData() {
            localStorage.setItem('medications', JSON.stringify(medications));
            localStorage.setItem('dailyLogs', JSON.stringify(dailyLogs));
        }
        
        function speak(text) {
            // Simple voice feedback for seniors (works in most modern browsers)
            if ('speechSynthesis' in window) {
                // Cancel any ongoing speech
                window.speechSynthesis.cancel();
                
                // Create utterance with senior-friendly settings
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.85; // Slightly slower
                utterance.pitch = 0.9;
                utterance.volume = 1.0;
                
                // Use first available voice (prioritize female voices which are often clearer)
                const voices = window.speechSynthesis.getVoices();
                const preferredVoice = voices.find(voice => 
                    voice.name.includes('Female') || 
                    voice.name.includes('Google US English') ||
                    voice.lang.includes('en-US')
                ) || voices[0];
                
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }
                
                window.speechSynthesis.speak(utterance);
            }
        }
        
        // Initialize speech synthesis voices (some browsers require user interaction first)
        window.speechSynthesis.onvoiceschanged = () => {
            // Voices are ready
        };
        
        // ======================
        // SAMPLE DATA FOR DEMO
        // ======================
        if (medications.length === 0 && !localStorage.getItem('meds_initialized')) {
            // Add sample medications for demo purposes
            medications = [
                {
                    name: "Lisinopril",
                    dosage: "10mg tablet",
                    time_of_day: "Morning",
                    current_count: 28,
                    total_prescribed: 30
                },
                {
                    name: "Metformin",
                    dosage: "500mg tablet",
                    time_of_day: "Afternoon",
                    current_count: 25,
                    total_prescribed: 30
                },
                {
                    name: "Atorvastatin",
                    dosage: "20mg tablet",
                    time_of_day: "Evening",
                    current_count: 29,
                    total_prescribed: 30
                }
            ];
            
            // Initialize today's log
            dailyLogs[today] = {
                date: today,
                taken: {
                    "Lisinopril": false,
                    "Metformin": false,
                    "Atorvastatin": false
                }
            };
            
            localStorage.setItem('medications', JSON.stringify(medications));
            localStorage.setItem('dailyLogs', JSON.stringify(dailyLogs));
            localStorage.setItem('meds_initialized', 'true');
            updateUI();
        }
    </script>
</body>
</html>
